<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consulta de Estado de Cuenta</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body { background-color: #f8f9fa; }
.logo { max-height: 60px; }
.header-bar { background-color:white; padding:1rem 2rem; box-shadow:0 0 10px rgba(0,0,0,0.05); }
.logout-btn { border-radius:20px; font-weight:500; }
.card { border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:2rem; background:#fff; }
.form-control { border-radius:10px; }
.btn-custom { background-color:#0d6efd; color:white; font-weight:500; }
.btn-custom:hover { background-color:#084298; }
.section-title { margin-top:2rem; color:#495057; }
</style>
</head>
<body>

<div class="header-bar d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center">
    <img src="https://maxikash.mx/cdn/shop/files/Logotipo-Maxikash-Outline.png?v=1749328460" alt="Logo" class="logo me-3">
    <h5 class="mb-0 text-secondary">Consulta de Estado de Cuenta</h5>
  </div>
  {% if session.get('usuario') %}
  <div class="text-end">
    <a href="/documentos" class="btn btn-outline-primary logout-btn">Consulta Documentos</a>
    <a href="/logout" class="btn btn-outline-danger logout-btn">Cerrar sesión</a>
  </div>
  {% endif %}
</div>
<div><br></div>

<div class="container py-4 d-flex flex-column align-items-center">
    <div class="col-md-8">
        <div class="card">
            <h3 class="text-center mb-4">Consulta de Estado de Cuenta</h3>
            <form id="formConsulta">
                <div class="mb-3">
                    <label for="idCredito" class="form-label">ID Crédito</label>
                    <input type="text" class="form-control" id="idCredito" required maxlength="10" pattern="\d{1,10}" title="Solo números">
                </div>
                <div class="mb-3" style="display:none;">
                    <label for="fechaCorte" class="form-label">Fecha de Corte</label>
                    <input type="date" class="form-control" id="fechaCorte" required>
                </div>
                <button type="submit" class="btn btn-custom w-100">Consultar</button>
            </form>
        </div>

        <!-- Contenedor para mostrar tabla de estado de cuenta -->
        <div id="resultadoContainer" class="mt-4" style="display:none;">
            <h5 class="section-title">Estado de Cuenta</h5>
            <table class="table table-sm table-bordered" id="tablaEstado">
                <thead>
                    <tr>
                        <th>Cuota</th>
                        <th>Fecha</th>
                        <th>Monto Cargo</th>
                        <th>Capital</th>
                        <th>Interés</th>
                        <th>Seguro</th>
                        <th>Total Pagado</th>
                        <th>Pendiente</th>
                        <th>Excedente</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const today = new Date();
document.getElementById('fechaCorte').value = today.toISOString().slice(0,10);

document.getElementById('formConsulta').addEventListener('submit', async function(e){
    e.preventDefault();

    const idCredito = document.getElementById('idCredito').value.trim();
    const fechaCorte = document.getElementById('fechaCorte').value;

    if(!/^\d+$/.test(idCredito)) {
        Swal.fire({ icon:'error', title:'ID inválido', text:'El ID crédito debe ser un número entero' });
        return;
    }

    Swal.fire({ title:'Consultando...', allowOutsideClick:false, didOpen: () => Swal.showLoading() });

    try {
        const res = await fetch('/', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ idCredito, fechaCorte })
        });
        const data = await res.json();
        Swal.close();

        if(data.http !== 200) {
            Swal.fire({ icon:'error', title:'Error', text: data.mensaje[0] || 'Error desconocido' });
            document.getElementById('resultadoContainer').style.display = 'none';
            return;
        }

        // Si no hay clientes ni cargos
        const estado = data.estadoCuenta;
        if(!estado.datosCliente || estado.datosCliente.length === 0 || !estado.datosCargos || estado.datosCargos.length === 0) {
            Swal.fire({ icon:'info', title:'Sin datos', text: data.mensaje[0] || 'No se encontraron datos para este crédito' });
            document.getElementById('resultadoContainer').style.display = 'none';
            return;
        }

        // Mostrar tabla
        const tbody = document.querySelector('#tablaEstado tbody');
        tbody.innerHTML = '';
        estado.datosCargos.forEach(cargo => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${cargo.cuota || '-'}</td>
                <td>${cargo.fechaVencimiento || '-'}</td>
                <td>${cargo.monto || 0}</td>
                <td>${cargo.capital || 0}</td>
                <td>${cargo.interes || 0}</td>
                <td>${(cargo.seguroBienes||0)+(cargo.seguroVida||0)+(cargo.seguroDesempleo||0)}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('resultadoContainer').style.display = 'block';

        Swal.fire({ icon:'success', title:'Consulta completada', text: data.mensaje[0] });

    } catch(err) {
        Swal.close();
        Swal.fire({ icon:'error', title:'Error', text: err.message });
        document.getElementById('resultadoContainer').style.display = 'none';
    }
});
</script>
</body>
</html>
