<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consulta de Documentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

    <style>
        body { background-color: #f8fafc; }
        #pdfContainer { border:1px solid #ccc; padding:10px; text-align:center; background:#fff; }
        canvas { margin: 10px 0; border:1px solid #ddd; }
        .controls { margin-bottom:10px; }
    </style>
</head>
<body>
<div class="container py-5">
    <h2 class="text-center mb-4">Consulta de Documentos</h2>

    <div class="row justify-content-center">
        <div class="col-md-6">
            <form id="formConsulta">
                <div class="mb-3">
                    <label for="idDocumento" class="form-label">ID Crédito</label>
                    <input type="text" class="form-control" id="idDocumento" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Buscar Documento</button>
            </form>
        </div>
    </div>

    <div class="row mt-4" id="visorContainer" style="display:none;">
        <div class="col-12">
            <div class="controls mb-2">
                <button class="btn btn-sm btn-secondary" id="prevPage">Anterior</button>
                <button class="btn btn-sm btn-secondary" id="nextPage">Siguiente</button>
                <span>Página: <span id="pageNum">1</span> / <span id="pageCount">1</span></span>
                <button class="btn btn-sm btn-secondary" id="zoomIn">+</button>
                <button class="btn btn-sm btn-secondary" id="zoomOut">-</button>
            </div>
            <div id="pdfContainer"></div>
        </div>
    </div>
</div>

<script>
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

let pdfDoc = null, pageNum = 1, scale = 1.5;

const container = document.getElementById('pdfContainer');
const pageNumSpan = document.getElementById('pageNum');
const pageCountSpan = document.getElementById('pageCount');

async function renderPage(num) {
    const page = await pdfDoc.getPage(num);
    const viewport = page.getViewport({ scale: scale });
    container.innerHTML = ''; // limpiar canvas anterior
    const canvas = document.createElement('canvas');
    container.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
    pageNumSpan.textContent = pageNum;
}

document.getElementById('formConsulta').addEventListener('submit', async function(e){
    e.preventDefault();
    const id = document.getElementById('idDocumento').value.trim();
    if (!id) return;

    const url = `/descargar/${id}`;

    try {
        const headResp = await fetch(url, { method:'HEAD' });
        if (!headResp.ok) throw new Error('Archivo no encontrado');

        pdfDoc = await pdfjsLib.getDocument(url).promise;
        pageNum = 1;
        pageCountSpan.textContent = pdfDoc.numPages;
        renderPage(pageNum);
        document.getElementById('visorContainer').style.display = 'block';
    } catch(err) {
        Swal.fire({ icon:'error', title:'Error', text: err.message });
        document.getElementById('visorContainer').style.display = 'none';
    }
});

document.getElementById('prevPage').addEventListener('click', () => {
    if (pageNum <= 1) return;
    pageNum--;
    renderPage(pageNum);
});

document.getElementById('nextPage').addEventListener('click', () => {
    if (pageNum >= pdfDoc.numPages) return;
    pageNum++;
    renderPage(pageNum);
});

document.getElementById('zoomIn').addEventListener('click', () => {
    scale += 0.2;
    renderPage(pageNum);
});

document.getElementById('zoomOut').addEventListener('click', () => {
    if(scale <= 0.4) return;
    scale -= 0.2;
    renderPage(pageNum);
});
</script>
</body>
</html>
