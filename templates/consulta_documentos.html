<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consulta de Documentos</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

<style>
body { background-color: #f8f9fa; }

.header-bar {
  background-color: white;
  padding: 1rem 2rem;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
  margin-bottom: 2rem;
}

.logo { max-height: 60px; }

.card-custom {
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 2rem;
    background-color: #fff;
    margin-bottom: 2rem;
}

#pdfContainer { 
    border:1px solid #ccc; 
    padding:10px; 
    text-align:center; 
    background:#fff; 
    max-height: 600px; 
    overflow-y: auto; 
}

canvas {
    margin: 10px 0; 
    border:1px solid #ddd; 
    display:block; 
    margin-left:auto; 
    margin-right:auto;
    width: 100% !important;
    height: auto !important;
}

.controls { 
    margin-bottom:10px; 
    text-align:center; 
}

img.documento-imagen { 
    max-width: 100%; 
    margin-top:10px; 
    border:1px solid #ddd; 
}

.btn-custom { 
    background-color: #0d6efd; 
    color: white; 
    font-weight: 500; 
    border-radius: 8px;
}
.btn-custom:hover { 
    background-color: #084298; 
}

/* Loader */
#loader {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

/* Tabla con cabecera fija */
.table-container {
    max-height: 400px; /* Ajusta altura según necesites */
    overflow-y: auto;
}

.table-container table thead th {
    position: sticky;
    top: 0;
    background-color: #fff;
    z-index: 2;
}
</style>
</head>
<body>

<div class="header-bar d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center">
    <img src="https://maxikash.mx/cdn/shop/files/Logotipo-Maxikash-Outline.png?v=1749328460" alt="Logo" class="logo me-3">
    <h5 class="mb-0 text-secondary">Consulta de Documentos</h5>
  </div>
  {% if session.get('usuario') %}
  <div class="text-end">
    <a href="/" class="btn btn-outline-primary logout-btn">Consulta Estado de Cuenta</a>
    <a href="/logout" class="btn btn-outline-danger logout-btn">Cerrar sesión</a>
  </div>
  {% endif %}
</div>

<div class="container py-4">
    <!-- Formulario -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card card-custom">
                <h3 class="text-center mb-4">Consulta Documentos</h3>
                <form id="formConsulta" class="d-flex flex-column">
                    <div class="mb-3">
                        <label for="idDocumento" class="form-label">ID Crédito / Persona</label>
                        <input type="text" class="form-control" id="idDocumento" required 
       pattern="\d{1,10}" maxlength="10" title="Solo números, máximo 10 dígitos">
                    </div>
                    <div class="mb-3">
                        <label for="tipoDocumento" class="form-label">Tipo de Documento</label>
                        <select id="tipoDocumento" class="form-select" required>
                            <option value="INE">INE (Frente + Reverso)</option>
                            <option value="Contrato">Contrato</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-custom w-100 mt-3">Buscar Documento</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Tabla de pagos con cabecera fija -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card card-custom">
                <h3 class="text-center mb-4">Pagos Realizados</h3>
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Monto</th>
                                <th>Concepto</th>
                                <th>Estatus</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>2025-09-12</td>
                                <td>$1,000</td>
                                <td>Pago parcial</td>
                                <td>Pagado</td>
                            </tr>
                            <tr>
                                <td>2025-09-05</td>
                                <td>$2,500</td>
                                <td>Pago completo</td>
                                <td>Pagado</td>
                            </tr>
                            <tr>
                                <td>2025-08-28</td>
                                <td>$500</td>
                                <td>Abono</td>
                                <td>Pendiente</td>
                            </tr>
                            <!-- Más filas según tus datos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Visor de Documento -->
    <div class="row justify-content-center">
        <div class="col-md-8" id="visorContainer" style="display:none;">
            <div class="card card-custom">
                <h3 class="text-center mb-4">Visor de Documento</h3>

                <!-- Loader -->
                <div id="loader" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <div>Cargando documento...</div>
                </div>

                <div class="controls mb-2">
                    <button class="btn btn-sm btn-secondary me-1" id="zoomIn">+</button>
                    <button class="btn btn-sm btn-secondary" id="zoomOut">-</button>
                </div>
                <div id="pdfContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

const container = document.getElementById('pdfContainer');
let scale = 1.0;
let currentPdf = null;
let currentBlob = null;

function drawWatermark(ctx, width, height, text = "SIN VALOR") {
    ctx.save();
    ctx.globalAlpha = 0.3;
    ctx.fillStyle = "rgb(255,0,0)";  
    ctx.font = "bold 50px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const stepX = 200;
    const stepY = 150;
    const angle = -Math.PI / 4;

    for (let y = -height; y < height * 2; y += stepY) {
        for (let x = -width; x < width * 2; x += stepX) {
            ctx.save();
            ctx.translate(x + stepX/2, y + stepY/2);
            ctx.rotate(angle);
            ctx.fillText(text, 0, 0);
            ctx.restore();
        }
    }
    ctx.restore();
}

async function renderPdf(blob) {
    currentPdf = await pdfjsLib.getDocument({ data: await blob.arrayBuffer() }).promise;
    container.innerHTML = '';
    const containerWidth = container.clientWidth - 20;

    for (let num = 1; num <= currentPdf.numPages; num++) {
        const page = await currentPdf.getPage(num);
        let viewport = page.getViewport({ scale: 1 }); 
        let scaleFit = Math.min(scale, containerWidth / viewport.width);
        viewport = page.getViewport({ scale: scaleFit });

        const ratio = window.devicePixelRatio || 1;
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width * ratio;
        canvas.height = viewport.height * ratio;
        canvas.style.width = '100%';
        canvas.style.height = 'auto';

        const ctx = canvas.getContext('2d');
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        drawWatermark(ctx, canvas.width, canvas.height);
        container.appendChild(canvas);
    }
}

function renderImageWithWatermark(blob) {
    container.innerHTML = '';
    const img = document.createElement('img');
    img.src = URL.createObjectURL(blob);
    img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        drawWatermark(ctx, canvas.width, canvas.height);
        container.innerHTML = '';
        container.appendChild(canvas);
    };
}

document.getElementById('zoomIn').onclick = () => { 
    if(currentBlob){ scale *= 1.2; renderPdf(currentBlob); } 
};
document.getElementById('zoomOut').onclick = () => { 
    if(currentBlob){ scale /= 1.2; renderPdf(currentBlob); } 
};

document.getElementById('formConsulta').addEventListener('submit', async function(e){
    e.preventDefault();
    const id = document.getElementById('idDocumento').value.trim();
    const tipo = document.getElementById('tipoDocumento').value;
    if (!id) return;

    const url = `/descargar/${id}?tipo=${tipo}`;

    // Mostrar loader
    document.getElementById('loader').style.display = 'flex';
    document.getElementById('visorContainer').style.display = 'block';
    container.innerHTML = '';

    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        currentBlob = blob;

        if (tipo === 'INE' || tipo === 'Contrato') {
            scale = 1.0;
            await renderPdf(blob);
        } else {
            renderImageWithWatermark(blob);
        }
    } catch (err) {
        Swal.fire({ icon:'error', title:'Error', text: err.message });
        document.getElementById('visorContainer').style.display = 'none';
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
});
</script>
</body>
</html>
